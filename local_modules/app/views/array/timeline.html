{% extends "../shared/shared_layout.html" %}

{% block headSuffix %}
    <title>Arrays - {{ arrayTitle }}</title>
    
    
{% endblock %}

{% block bodyWrapper %}
    <body class="array array-timeline source-{{ array_source_key }}">
        <div id="page" class="site">
            {% set currentView = "timeline" %}
            {% include "../partials/header_bar_array.html" %}
            {% include "../partials/sidebar_filter.html" %}

            <div id="content" class="site-content">

                <section class="array">

                    <header class="array-header header-shadow array-header-small clearfix">
                        <div class="container-fluid">
                            <h1 class="array-title">{{ arrayTitle }}</h1>
                            <div class="array-meta">
                                {% if sourceDocURL %}<a href="{{ sourceDocURL }}" target="_blank" class="array-meta-about color-brand">Source</a> <span class="array-meta-divider"></span> {% endif %}<span class="array-meta-count">{{ sourceDoc.numberOfRows | comma }} Record{{ "s" if sourceDoc.numberOfRows != 1 else "" }}</span> <span class="array-meta-divider hidden-xs"></span> <span class="array-meta-updated hidden-xs">Last Updated {{ sourceDoc.dateOfLastImport | dateFormattedAs_monthDayYear }}</span>
                            </div>
                        </div>
                    </header><!-- .array-header -->

                    <div id="array-controls" class="array-controls">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-sm-12">

                                    <div class="sort-bar clearfix">

                                        <nav class="pull-left" role="navigation">

                                            <div class="dropdown sort-control">
                                                <a class="btn dropdown-toggle dropdown-toggle-button ui-label group-by" type="button" id="group-by" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                    Group By <span class="sort-criteria color-brand-hover">{{ groupBy if groupBy else defaultGroupByColumnName_humanReadable }}</span>
                                                </a>
                                                {% if colNames_orderedForGroupByDropdown | length %}
                                                <ul class="dropdown-menu" aria-labelledby="group-by">
                                                    {% set groupBy_queryParamJoinChar = "?" if routePath_withoutGroupBy == routePath_base else "&" %}
                                                    {% for colName in colNames_orderedForGroupByDropdown %}
                                                    <li class="background-color-brand-hover"><a href="{{ routePath_withoutGroupBy }}{{ groupBy_queryParamJoinChar }}groupBy={{ colName }}">{{ colName }}</a></li>
                                                    {% endfor %}
                                                </ul>
                                                {% endif %}
                                            </div>

                                            <div class="dropdown sort-control">
                                                <a class="btn dropdown-toggle dropdown-toggle-button ui-label order-by" type="button" id="group-by" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                    Sort By <span class="sort-criteria color-brand-hover">{{ sortBy if sortBy else defaultSortByColumnName_humanReadable }}</span>
                                                </a>
                                                {% if colNames_orderedForTimelineSortByDropdown | length %}
                                                <ul class="dropdown-menu" aria-labelledby="sort-by">
                                                    {% set sortBy_queryParamJoinChar = "?" if routePath_withoutSortBy == routePath_base else "&" %}
                                                    {% for colName in colNames_orderedForTimelineSortByDropdown %}
                                                    <li class="background-color-brand-hover"><a href="{{ routePath_withoutSortBy }}{{ sortBy_queryParamJoinChar }}sortBy={{ colName }}">{{ colName }}</a></li>
                                                    {% endfor %}
                                                </ul>
                                                {% endif %}
                                            </div>
                                        </nav>

                                        <div class="pull-right">
                                            <form action="{{ routePath_base }}" method="get" class="form-search">
                                                <div class="sort-control visible-xs">
                                                    <div class="btn dropdown-toggle-button search-toggle">
                                                        <span class="icon-search search-icon"></span>
                                                    </div>
                                                </div>
                                                
                                                <div class="mobile-search-popover">
                                                    <div class="dropdown-toggle-button-group" role="group">
                                                        <div class="dropdown sort-control sort-control-left search-control">
                                                            {% set searchColToOutput = searchCol if searchCol else "Object Title" %}
                                                            
                                                            <a href="#" class="btn dropdown-toggle ui-label" data-toggle="dropdown" id="search-by" role="button" aria-haspopup="true" aria-expanded="false">
                                                                Search <span class="search-criteria color-brand-hover">{{ searchColToOutput }}</span>
                                                            </a>
                                                            <input type="hidden" name="searchCol" value="{{ searchColToOutput }}" class="search-colname">
                                                            {% if colNames_orderedForSortByDropdown | length %}
                                                            <ul class="dropdown-menu search-dropdown-menu" aria-labelledby="search-by">
                                                                {% for colName in colNames_orderedForSortByDropdown %}
                                                                <li class="search-dropdown-item background-color-brand-hover"><a href="#" data-colname="{{ colName }}">{{ colName }}</a></li>
                                                                {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>

                                                        <div class="sort-control sort-control-right">
                                                            <div class="dropdown-toggle">
                                                                <input type="text" name="searchQ" class="form-control search-input" placeholder="Type here to search" autocomplete="off" value="{{ searchQ if searchQ else "" }}">
                                                                <span class="icon-search search-icon hidden-xs"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {% if sortBy %}
                                                    <input type="hidden" name="sortBy" value="{{ sortBy }}">
                                                {% endif %}
                                                {% if sortDir %}
                                                    <input type="hidden" name="sortDir" value="{{ sortDir }}">
                                                {% endif %}
                                                {% if filterJSON %}
                                                    <input type="hidden" name="filterJSON" value="{{ filterJSON_nonURIEncodedVals }}"> {# it will get re-encoded #}
                                                {% endif %}
                                            </form>
                                        </div>

                                    </div>

                                </div>
                            </div><!-- .row -->
                        </div>
                    </div>

                    <div class="array-content">

                        <div class="timeline-container">

                            {% if isFilterActive %}
                            <div class="filter-bar filter-bar-fixed-bottom">
                                <div class="container-fluid">
                                    {% set queryParamJoinChar = "?" if routePath_withoutFilter == routePath_base else "&" %}
                                    {% for filterCol, filterVals in filterObj %}
                                        {% for filterVal in filterVals %}
                                            {% set filterObjForThisFilterColVal = filterObj | constructedFilterObj(filterCol, filterVal, true) %}
                                            {% set filterJSONString = filterObjForThisFilterColVal | jsonStringify %}
                                            {% set routePath_withoutThisFilter = routePath_withoutFilter + queryParamJoinChar + "filterJSON=" + filterJSONString %}
                                            {% set shouldDisplayKey = false if truesByFilterValueByFilterColumnName_forWhichNotToOutputColumnNameInPill[filterCol][filterVal] else true %}                  
                                    <span class="filter-tag border-color-brand">{{ filterCol | safe if shouldDisplayKey else "" }}{{ ": " if shouldDisplayKey else ""}}{{ filterVal | safe }} <a href="{{ routePath_withoutThisFilter }}" class="close filter-tag-close"><span class="icon-close-filterpill" aria-hidden="true"></span></a></span>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-sm-12">

                                    <div class="timeline">

                                    {# <pre>{{ groupedResults | dump | safe }}</pre> #}

                                    {# {{ sortBy_realColumnName }} #}
                                    {# {{ groupBy_realColumnName }} #}

                                        {% if groupedResults | length %}
                                            <ul class="timeline-list">
                                                {% for group in groupedResults %}
                                                    {% if group.results | length %}
                                                        <li class="timeline-group">
                                                            <span class="timeline-group-label">{{ group.startDate | dateFormat(groupByDateFormat) }}{% if group.startDate | dateFormat(groupByDateFormat) != group.endDate | dateFormat(groupByDateFormat) %}&ndash;{{ group.endDate | dateFormat(groupByDateFormat) }}{% endif %}</span>
                                                            <ul class="timeline-group-list">
                                                                {% for doc in group.results %}
                                                                    {% if hasThumbs and doc.rowParams[fieldKey_medThumbImageURL] %}
                                                                        {% include "../partials/timeline_item.html" %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {% if groupedResultsLimit < group.total %}
                                                                    <li class="timeline-group-item">
                                                                        <div class="timeline-item timeline-view-all">
                                                                            {% set queryParamJoinChar = "?" %}
                                                                            {% set filterObjForThisFilterColVal = filterObj | constructedFilterObj(sortBy_realColumnName, group.startDate, false) %}
                                                                            {% set filterJSONString = filterObjForThisFilterColVal | jsonStringify %}
                                                                            {% set urlForFilterValue = "/array/" + array_source_key +  "/gallery" + queryParamJoinChar + "filterJSON=" + filterJSONString %}
                                                                            <a href="{{ urlForFilterValue }}" class="timeline-view-all-link">
                                                                                <span class="timeline-view-all-label">View all</span>
                                                                                <span class="timeline-view-all-count">{{ group.total }}</span>
                                                                            </a>
                                                                        </div>
                                                                    </li>
                                                                {% endif %}
                                                            </ul>
                                                        </li>
                                                    {% endif %}
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                    </div>

                                    </div>
                                </div><!-- .row -->
                            </div><!-- .container-fluid -->

                        </div><!-- .chart-container -->

                    </div><!-- .array-content -->

                </section>

            </div><!-- #content -->

        </div><!-- #page -->

        {% include "../partials/modal.html" %}

        <script src="https://code.jquery.com/jquery-2.2.2.min.js" integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin="anonymous"></script>
        
        <script type="text/javascript" src="/javascripts/lib/bootstrap/bootstrap.js"></script>
        <script type="text/javascript" src="/javascripts/lib/sharrre/jquery.sharrre.js"></script>
        <script type="text/javascript" src="/javascripts/lib/scrollmagic/ScrollMagic.js"></script>
        <script type="text/javascript" src="/javascripts/main.js"></script>
        <script type="text/javascript" src="/javascripts/module/gallery.js"></script>
        <script type="text/javascript" src="/javascripts/module/timeline.js"></script>

        {% include "../partials/survicate.html" %}
    </body>
{% endblock %}