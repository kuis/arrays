{% set currentView = "globe" %}

{% extends "../layout/array.html" %}

{% import "../partials/dropdown.html" as dropdown %}
{% import "../partials/search.html" as search %}
{% import "../partials/filter.html" as filter %}

{% block headSuffix %}
    <title>Arrays - {{ arrayTitle }}</title>
    <script id="earth-front-vertex-shader" type="x-shader/x-vertex">
      varying vec3 vNormal;
      varying vec2 vUv;
      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        vNormal = normalize( normalMatrix * normal );
        vUv = uv;
      }
    </script>
    <script id="earth-front-fragment-shader" type="x-shader/x-fragment">
      uniform sampler2D texture;
      varying vec3 vNormal;
      varying vec2 vUv;
      void main() {
        vec3 diffuse = vec3(0.01, 0.13, 0.17);
        float mask = texture2D(texture, vUv).x;
        float opacity = 0.75 + (mask * 0.25);
        float intensity = 1.05 - dot(vNormal, vec3(0.0, 0.0, 1.0));
        vec3 atmosphere = vec3(0.4, 0.8, 0.9) * 0.7 * pow(intensity, 3.0);
        vec3 land = diffuse + atmosphere;
        vec3 ocean = vec3(0, 0, 0) + atmosphere;
        vec3 color = (land * mask) + (ocean * (1.0 - mask));
        gl_FragColor = vec4(color, opacity);
      }
    </script>
    <script id="earth-back-vertex-shader" type="x-shader/x-vertex">
      varying vec2 vUv;
      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        vUv = uv;
      }
    </script>
    <script id="earth-back-fragment-shader" type="x-shader/x-fragment">
      uniform sampler2D texture;
      varying vec2 vUv;
      void main() {
        float opacity = texture2D(texture, vUv).x;
        vec3 diffuse = vec3(0.06, 0.32, 0.44); //vec3(0.015, 0.08, 0.11);
        gl_FragColor = vec4(diffuse, opacity);
      }
    </script>
    <script id="atmosphere-vertex-shader" type="x-shader/x-vertex">
      varying vec3 vNormal;
      void main() {
        vNormal = normalize( normalMatrix * normal );

        vec3 newPosition = position +
                   normal *
                   vec3(1);

        gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0 );
      }
    </script>
    <script id="atmosphere-fragment-shader" type="x-shader/x-fragment">
      varying vec3 vNormal;
      void main() {
        float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 2.0 );
        gl_FragColor = vec4( 0, 0.08, 0.1, 1.0 ) * intensity;
      }
    </script>
{% endblock %}

{% block content %}
    <section class="array">

        <header class="array-header header-shadow array-header-small clearfix">
            <div class="container-fluid">
                <h1 class="array-title">{{ arrayTitle }}</h1>
                <div class="array-meta">
                    {% if sourceDocURL %}<a href="{{ sourceDocURL }}" target="_blank" class="array-meta-about color-brand">Source</a> <span class="array-meta-divider"></span> {% endif %}<span class="array-meta-count">{{ sourceDoc.numberOfRows | comma }} Record{{ "s" if sourceDoc.numberOfRows != 1 else "" }}</span> <span class="array-meta-divider hidden-xs"></span> <span class="array-meta-updated hidden-xs">Last Updated {{ sourceDoc.dateOfLastImport | dateFormattedAs_monthDayYear }}</span>
                </div>
            </div>
        </header><!-- .array-header -->

        <div class="map-description-wrapper">
        {% if view_description %}

            <div class="array-description-wrapper">
                <p class="array-description">{{ view_description }}</p>
            </div>

        {% endif %}
        </div>

        <div class="map-container">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="sort-bar clearfix">

                            <nav style="display: {{ 'none' if isCoordMap else 'block' }};" class="sort-bar-left pull-left" role="navigation">
                                {{
                                dropdown.default(
                                    'Map By',
                                    mapBy if mapBy else defaultMapByColumnName_humanReadable,
                                    colNames_orderedForMapByDropdown,
                                    routePath_base | constructedRoutePath(filterObj, {
                                        searchCol: searchCol,
                                        searchQ: searchQ,
                                        mapBy: ''
                                    })
                                )
                                }}
                            </nav>

                            <div class="sort-bar-right pull-right">
                                {{
                                search.panel(
                                    routePath_base,
                                    searchCol if searchCol else "Object Title",
                                    colNames_orderedForSortByDropdown,
                                    searchQ if searchQ else "",
                                    sortBy,
                                    sortDir,
                                    filterObj
                                )
                                }}
                            </div>

                        </div>

                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->

            {% if isFilterActive %}
                {{
                filter.default(displayTitleOverrides,
                    routePath_base | constructedRoutePath(null, {
                        searchCol: searchCol,
                        searchQ: searchQ,
                        mapBy: mapBy
                    }),
                    filterObj,
                    truesByFilterValueByFilterColumnName_forWhichNotToOutputColumnNameInPill,
                    false,
                    'filter-bar-fixed-bottom'
                )
                }}
            {% endif %}

            <script type="text/javascript">
            // extract variables needed in /javascripts/globe.js
            </script>

            <div class="array-content">

                <div id="globe"></div>

            </div>
        </div>

    </section>
{% endblock %}

{% block inlineScript %}
    {{ super() }}

    <!-- add webGL library -->
    <script type="text/javascript" src="/vendors/threejs/build/three.min.js"></script>
    <script type="text/javascript" src="/vendors/lodash/dist/lodash.min.js"></script>
    <script type="text/javascript" src="/javascripts/globe/main.js"></script>
    <script type="text/javascript" src="/javascripts/globe/city-node.js"></script>
    <script type="text/javascript" src="/javascripts/globe/line.js"></script>
    <script type="text/javascript" src="/javascripts/globe/globe.js"></script>
    <script type="text/javascript" src="/javascripts/globe/globe-view.js"></script>
    <script type="text/javascript" src="/javascripts/banner.js"></script>
{% endblock %}
