{% extends "../layout/array.html" %}
{% import "../partials/dropdown.html" as dropdown %}
{% import "../partials/search.html" as search %}

{% block headSuffix %}
    <title>Arrays - {{ arrayTitle }}</title>
{% endblock %}

{% set currentView = "word-cloud" %}

{% block content %}
    <section class="array">

        <header class="array-header header-shadow array-header-small clearfix">
            <div class="container-fluid">
                <h1 class="array-title">{{ arrayTitle }}</h1>
                <div class="array-meta">
                    {% if sourceDocURL %}<a href="{{ sourceDocURL }}" target="_blank" class="array-meta-about color-brand">Source</a> <span class="array-meta-divider"></span> {% endif %}<span class="array-meta-count">{{ sourceDoc.numberOfRows | comma }} Record{{ "s" if sourceDoc.numberOfRows != 1 else "" }}</span> <span class="array-meta-divider hidden-xs"></span> <span class="array-meta-updated hidden-xs">Last Updated {{ sourceDoc.dateOfLastImport | dateFormattedAs_monthDayYear }}</span>
                </div>
            </div>
        </header><!-- .array-header -->

        <div class="array-content">

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="sort-bar clearfix">

                            <nav class="pull-left" role="navigation">
                                {% set groupBy_queryParamJoinChar = "?" if routePath_withoutGroupBy == routePath_base else "&" %}
                                {{
                                dropdown.default(
                                    'Chart By',
                                    groupBy if groupBy else defaultGroupByColumnName_humanReadable,
                                    colNames_orderedForGroupByDropdown,
                                    routePath_withoutGroupBy + groupBy_queryParamJoinChar + 'groupBy=',
                                    true,
                                    false
                                )
                                }}
                            </nav>

                            <div class="pull-right">
                                {{
                                search.panel(
                                    routePath_base,
                                    searchCol if searchCol else "Object Title",
                                    colNames_orderedForSortByDropdown,
                                    searchQ if searchQ else "",
                                    sortBy,
                                    sortDir,
                                    filterJSON_nonURIEncodedVals
                                )
                                }}

                                <a class="btn dropdown-toggle-button legend-toggle hidden-xs">
                                    <span class="icon-legend" aria-hidden="true"></span>
                                </a>
                            </div>

                        </div>
                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->

            {% if isFilterActive %}
            <div class="filter-bar filter-bar-fixed-bottom">
                <div class="container-fluid">
                    {% set queryParamJoinChar = "?" if routePath_withoutFilter == routePath_base else "&" %}
                    {% for filterCol, filterVals in filterObj %}
                        {% for filterVal in filterVals %}
                            {% set filterObjForThisFilterColVal = filterObj | constructedFilterObj(filterCol, filterVal, true) %}
                            {% set filterJSONString = filterObjForThisFilterColVal | jsonStringify %}
                            {% set routePath_withoutThisFilter = routePath_withoutFilter + queryParamJoinChar + "filterJSON=" + filterJSONString %}
                            {% set shouldDisplayKey = false if truesByFilterValueByFilterColumnName_forWhichNotToOutputColumnNameInPill[filterCol][filterVal] else true %}
                    <span class="filter-tag border-color-brand">{{ filterCol | safe if shouldDisplayKey else "" }}{{ ": " if shouldDisplayKey else ""}}{{ filterVal | filterValToDisplay }} <a href="{{ routePath_withoutThisFilter }}" class="close filter-tag-close"><span class="icon-close-filterpill" aria-hidden="true"></span></a></span>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        {# {{ groupedResults | dump }} #}

                        {# max: {{ maxGroupedResultsValue }} #}

                        {% if groupedResults | length %}
                            {% set queryParamJoinChar = "?" if routePath_withoutFilter == routePath_base else "&" %}
                            <ul class="word-cloud-list">
                            {% for result in groupedResults %}
                                {% set filterObjForThisFilterColVal = filterObj | constructedFilterObj(defaultGroupByColumnName_humanReadable, result._id, false) %}
                                {% set filterJSONString = filterObjForThisFilterColVal | jsonStringify %}
                                {% set urlForFilterValue = routePath_withoutFilter + queryParamJoinChar + "filterJSON=" + filterJSONString %}
                                <li class="word-cloud-item">
                                    <a href="{{ urlForFilterValue }}" class="word-cloud-link border-color-brand-hover has-tooltip" data-tooltip-key="{{ result._id }}" data-tooltip-value="{{ result.value }}">
                                        <span class="word-cloud-label color-brand" style="font-size: {{ (result.value - minGroupedResultsValue) / (maxGroupedResultsValue - minGroupedResultsValue) * 350 + 100 | round() }}%">{{ result._id }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                            </ul>
                        {% endif %}

                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->

        </div><!-- .array-content -->

    </section>
{% endblock %}

{% block inlineScript %}
    {{ super() }}

    <script type="text/javascript" src="/javascripts/module/word-cloud.js"></script>
{% endblock %}
