{% set currentView = "bar-chart" %}

{% extends "../layout/array.html" %}

{% import "../partials/dropdown.html" as dropdown %}
{% import "../partials/search.html" as search %}
{% import "../partials/filter.html" as filter %}

{% block headSuffix %}
    <title>Arrays - {{ arrayTitle }}</title>
{% endblock %}

{% block content %}
    <section class="array">

        <header class="array-header header-shadow array-header-small clearfix">
            <div class="container-fluid">
                <h1 class="array-title">{{ arrayTitle }}</h1>
                <div class="array-meta">
                    {% if sourceDocURL %}<a href="{{ sourceDocURL }}" target="_blank" class="array-meta-about color-brand">Source</a> <span class="array-meta-divider"></span> {% endif %}<span class="array-meta-count">{{ sourceDoc.numberOfRows | comma }} Record{{ "s" if sourceDoc.numberOfRows != 1 else "" }}</span> <span class="array-meta-divider hidden-xs"></span> <span class="array-meta-updated hidden-xs">Last Updated {{ sourceDoc.dateOfLastImport | dateFormattedAs_monthDayYear }}</span>
                </div>
            </div>
        </header><!-- .array-header -->

        <div class="array-content">

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="sort-bar clearfix">

                            <nav class="sort-bar-left pull-left" role="navigation">
                                {% if colNames_orderedForAggregateByDropdown %}
                                {{
                                dropdown.sortbar(
                                    'Y Axis',
                                    aggregateBy if aggregateBy else defaultAggregateByColumnName_humanReadable,
                                    colNames_orderedForAggregateByDropdown,
                                    routePath_base | constructedRoutePath(filterObj, {
                                        searchCol: searchCol,
                                        searchQ: searchQ,
                                        stackBy: stackBy,
                                        sortDir: sortDir,
                                        groupBy: groupBy,
                                        aggregateBy: ''
                                    })
                                )
                                }}
                                {% endif %}

                                {% if colNames_orderedForGroupByDropdown %}
                                {{
                                dropdown.sortbar(
                                    'X Axis',
                                    groupBy if groupBy else defaultGroupByColumnName_humanReadable,
                                    colNames_orderedForGroupByDropdown,
                                    routePath_base | constructedRoutePath(filterObj, {
                                        searchCol: searchCol,
                                        searchQ: searchQ,
                                        stackBy: stackBy,
                                        sortDir: sortDir,
                                        aggregateBy: aggregateBy,
                                        groupBy: ''
                                    })
                                )
                                }}
                                {% endif %}

                                {% if colNames_orderedForStackByDropdown %}
                                {{
                                dropdown.sortbar
                                (
                                    "Stack By",
                                    stackBy if stackBy else defaultStackByColumnName_humanReadable,
                                    colNames_orderedForStackByDropdown,
                                    routePath_base | constructedRoutePath(filterObj, {
                                        searchCol: searchCol,
                                        searchQ: searchQ,
                                        aggregateBy: aggregateBy,
                                        groupBy: groupBy,
                                        sortDir: sortDir,
                                        stackBy: ''
                                    })
                                )
                                }}
                                {% endif %}

                                <div class="sort-control sort-direction">
                                    {% if sortDir == "Descending" %}
                                    <a title="Sort Ascending" href="{{ routePath_base | constructedRoutePath(filterObj, {
                                            searchCol: searchCol,
                                            searchQ: searchQ,
                                            sortDir: 'Ascending',
                                            aggregateBy: aggregateBy,
                                            groupBy: groupBy,
                                            stackBy: stackBy,
                                            page: onPageNum if onPageNum != 1 else null }) }}"><span class="icon-sort-ascending sort-direction-icon" aria-hidden="true"></span></a>
                                    {% else %}
                                    <a title="Sort Descending" href="{{ routePath_base | constructedRoutePath(filterObj, {
                                            searchCol: searchCol,
                                            searchQ: searchQ,
                                            sortDir: 'Descending',
                                            aggregateBy: aggregateBy,
                                            groupBy: groupBy,
                                            stackBy: stackBy,
                                            page: onPageNum if onPageNum != 1 else null }) }}"><span class="icon-sort-descending sort-direction-icon" aria-hidden="true"></span></a>
                                    {% endif %}
                                </div>
                            </nav>

                            <div class="sort-bar-right pull-right">
                                {{
                                search.panel(
                                    routePath_base,
                                    searchCol if searchCol else "Object Title",
                                    colNames_orderedForSortByDropdown,
                                    searchQ if searchQ else "",
                                    null,
                                    null,
                                    filterObj
                                )
                                }}

                                <a class="btn dropdown-toggle-button legend-toggle hidden-xs">
                                    <span class="icon-legend" aria-hidden="true"></span>
                                </a>
                            </div>

                        </div>
                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->

            {% if isFilterActive %}
                {{
                filter.default(
                    routePath_base | constructedRoutePath(null, {
                        searchCol: searchCol,
                        searchQ: searchQ,
                        aggregateBy: aggregateBy,
                        groupBy: groupBy,
                        stackBy: stackBy,
                        sortBy: sortBy
                    }),
                    filterObj,
                    truesByFilterValueByFilterColumnName_forWhichNotToOutputColumnNameInPill,
                    false,
                    'filter-bar-fixed-bottom'
                )
                }}
            {% endif %}

            <script type="text/javascript">
                // var barColors = {{ barColors | dump | safe }};
                var filterObj = {{ filterObj | dump | safe }};
                var routePath_withoutFilter = '{{ routePath_base | constructedRoutePath(null, {
                        searchCol: searchCol,
                        searchQ: searchQ,
                        aggregateBy: aggregateBy,
                        groupBy: groupBy,
                        stackBy: stackBy,
                        sortDir: sortDir
                }) | safe }}';
                var stackBy = '{{ stackBy if stackBy else defaultStackByColumnName_humanReadable }}';
                var stackBy_outputInFormat = '{{ stackBy_outputInFormat }}';

                var redirectBaseUrl = undefined;
                {% if mapping_source_pKey %}
                {% if mapping_default_view %}
                var default_view = '{{ mapping_default_view if mapping_default_view else "gallery"}}';
                {% endif %}
                var words = default_view.split(/(?=[A-Z])/);
                var default_view_url = words.map(function(word){ return word.toLowerCase(); }).join('-');
                redirectBaseUrl = '/array/{{ mapping_source_pKey }}/' + default_view_url
                        + '{{ "" | constructedRoutePath(mapping_default_filterObj, mapping_stackByObj) | safe }}';
                {% endif %}
                var options = {
                    redirectBaseUrl: redirectBaseUrl,
                    outputInFormat: stackBy_outputInFormat,
                    isHorizontal: {{ isHorizontal if isHorizontal else false }},
                    normalize: {{ isNormalized if isNormalized else false }},
                    padding: {{ padding if padding else false }}
                };
            </script>

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div id="bar-chart"></div>

                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->

        </div><!-- .array-content -->

    </section>
{% endblock %}

{% block inlineScript %}
    {{ super() }}

    <script type="text/javascript" src="/javascripts/lib/d3/d3.js"></script>
    <script type="text/javascript" src="/javascripts/module/barchart/barChart.js"></script>
    <script type="text/javascript" src="/javascripts/module/barchart/verticalBarChart.js"></script>
    <script type="text/javascript" src="/javascripts/module/barchart/horizontalBarChart.js"></script>
    <script>
        var graphData = {{graphData | dump | safe}};

        var barChart = BarChart.getInstance('#bar-chart', graphData, options);
    </script>
{% endblock %}