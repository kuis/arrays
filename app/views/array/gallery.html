{% extends "../layout/array.html" %}
{% import "../partials/dropdowns.html" as dropdowns %}

{% block headSuffix %}
    <title>Arrays - {{ arrayTitle }}</title>
{% endblock %}

{% set currentView = "gallery" %}

{% block content %}
    <section class="array">

        <header class="array-header header-shadow">
            <h1 class="array-title">{{ arrayTitle }}</h1>
            <div class="array-meta">{% if sourceDocURL %}<a href="{{ sourceDocURL }}" target="_blank" class="array-meta-about color-brand">Source</a> <span class="array-meta-divider hidden-xs"></span> {% endif %}<span class="array-meta-count hidden-xs">{{ sourceDoc.numberOfRows | comma }} Record{{ "s" if sourceDoc.numberOfRows != 1 else "" }}</span> <span class="array-meta-divider"></span> <span class="array-meta-updated">Last Updated {{ sourceDoc.dateOfLastImport | dateFormattedAs_monthDayYear }}</span></div>
        </header><!-- .array-header -->

        <div id="array-controls" class="array-controls">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="sort-bar clearfix">

                            <nav class="pull-left" role="navigation">

                                <div class="sort-control sort-direction">
                                    {% set sortDir_queryParamJoinChar = "?" if routePath_withoutSortDir == routePath_base else "&" %}
                                    {% if sortDir == "Descending" %}
                                        <a href="{{ routePath_withoutSortDir }}{{ sortDir_queryParamJoinChar }}sortDir=Ascending"><span class="icon-sort-ascending sort-direction-icon" aria-hidden="true"></span></a>
                                    {% else %}
                                        <a href="{{ routePath_withoutSortDir }}{{ sortDir_queryParamJoinChar }}sortDir=Descending"><span class="icon-sort-descending sort-direction-icon" aria-hidden="true"></span></a>
                                    {% endif %}
                                </div>

                                {% set sortBy_queryParamJoinChar = "?" if routePath_withoutSortBy == routePath_base else "&" %}
                                {{
                                dropdowns.default(
                                    'Sort By',
                                    sortBy if sortBy else defaultSortByColumnName_humanReadable,
                                    colNames_orderedForSortByDropdown,
                                    routePath_withoutSortBy + sortBy_queryParamJoinChar + 'sortBy=',
                                    false,
                                    false
                                )
                                }}

                            </nav>

                            <div class="pull-right">
                                <form action="{{ routePath_base }}" method="get" class="form-search">
                                    <div class="sort-control visible-xs">
                                        <div class="dropdown-toggle search-toggle">
                                            <span class="icon-search search-icon color-brand-hover"></span>
                                        </div>
                                    </div>

                                    <div class="mobile-search-popover dropdown-panel">
                                        <div class="dropdown sort-control search-control">
                                            {% set searchColToOutput = searchCol if searchCol else "Object Title" %}

                                            <a href="#" class="btn dropdown-toggle ui-label" data-toggle="dropdown" id="search-by" role="button" aria-haspopup="true" aria-expanded="false">
                                                Search <span class="search-criteria color-brand-hover">{{ searchColToOutput }}</span>
                                            </a>
                                            <input type="hidden" name="searchCol" value="{{ searchColToOutput }}" class="search-colname">
                                            {% if colNames_orderedForSortByDropdown | length %}
                                            <ul class="dropdown-menu search-dropdown-menu" aria-labelledby="search-by">
                                                {% for colName in colNames_orderedForSortByDropdown %}
                                                <li class="search-dropdown-item background-color-brand-hover"><a href="#" data-colname="{{ colName }}">{{ colName }}</a></li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        </div>

                                        <div class="sort-control">
                                            <div class="dropdown-toggle">
                                                <input type="text" name="searchQ" class="form-control search-input" placeholder="Type here to search" autocomplete="off" value="{{ searchQ if searchQ else "" }}">
                                                <span class="icon-search search-icon"></span>
                                            </div>
                                        </div>
                                    </div>

                                    {% if sortBy %}
                                        <input type="hidden" name="sortBy" value="{{ sortBy }}">
                                    {% endif %}
                                    {% if sortDir %}
                                        <input type="hidden" name="sortDir" value="{{ sortDir }}">
                                    {% endif %}
                                    {% if filterJSON %}
                                        <input type="hidden" name="filterJSON" value="{{ filterJSON_nonURIEncodedVals }}"> {# it will get re-encoded #}
                                    {% endif %}
                                </form>
                            </div>

                        </div>

                        {% if isFilterActive %}
                        <div class="filter-bar">
                            <span class="filter-label ui-label">Filters:</span>
                                {% set queryParamJoinChar = "?" if routePath_withoutFilter == routePath_base else "&" %}
                                {% for filterCol, filterVals in filterObj %}
                                    {% for filterVal in filterVals %}
                                        {% set filterObjForThisFilterColVal = filterObj | constructedFilterObj(filterCol, filterVal, true) %}
                                        {% set filterJSONString = filterObjForThisFilterColVal | jsonStringify %}
                                        {% set routePath_withoutThisFilter = routePath_withoutFilter + queryParamJoinChar + "filterJSON=" + filterJSONString %}
                                        {% set shouldDisplayKey = false if truesByFilterValueByFilterColumnName_forWhichNotToOutputColumnNameInPill[filterCol][filterVal] else true %}
                                <span class="filter-tag border-color-brand">{{ filterCol | safe if shouldDisplayKey else "" }}{{ ": " if shouldDisplayKey else ""}}{{ filterVal | filterValToDisplay }} <a href="{{ routePath_withoutThisFilter }}" class="close filter-tag-close"><span class="icon-close-filterpill" aria-hidden="true"></span></a></span>
                                    {% endfor %}
                                {% endfor %}
                        </div>
                        {% endif %}

                    </div>
                </div><!-- .row -->
            </div><!-- .container-fluid -->
        </div><!-- #array-controls -->

        <div class="array-content">

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="filter-count">
                            <span>{% if resultsOffset > 0 %}{{ resultsOffset + 1 }} &ndash; {% endif %}{{ (resultsOffset + (docs | length)) | comma }} of {{ nonpagedCount | comma }} Result{{ "s" if docs | length != 1 else "" }} in this set</span>
                        </div>

                        <div class="gallery">
                            <ul class="gallery-grid">
                                {% for doc in docs %}
                                    {% if hasThumbs and doc.rowParams[fieldKey_medThumbImageURL] %}
                                        {% include "../partials/gallery_item_image.html" %}
                                    {% else %}
                                        {% include "../partials/gallery_item_text.html" %}
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div><!-- .gallery -->

                        {% set lastPage = numPages | int %}
                        {% set currentPage = onPageNum | int %}

                        {% set showAlwaysFirstAndLast = true %}
                        {% set paging_queryParamJoinChar = "?" if routePath_withoutPage == routePath_base else "&" %}

                        {% if lastPage > 1 %}

                            {# the number of first and last pages to be displayed #}
                            {% set extremePagesLimit = 3 %}

                            {# the number of pages that are displayed around the active page #}
                            {% set nearbyPagesLimit = 2 %}

                            <nav class="gallery-pagination">
                                <ul class="pagination">
                                    {% if currentPage > 1 %}
                                        <li>
                                            <a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ currentPage - 1 }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>

                                        {% for i in range(1, extremePagesLimit) -%}
                                            {% if ( i < currentPage - nearbyPagesLimit ) %}
                                                <li><a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ i }}">{{ i }}</a></li>
                                            {% endif %}
                                        {%- endfor %}

                                        {% if extremePagesLimit + 1 < currentPage - nearbyPagesLimit %}
                                            <li><span>&hellip;</span></li>
                                        {% endif %}

                                        {% for i in range(currentPage-nearbyPagesLimit, currentPage) -%}
                                            {% if ( i > 0 ) %}
                                                <li><a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ i }}">{{ i }}</a></li>
                                            {% endif %}
                                        {%- endfor %}
                                    {% elif showAlwaysFirstAndLast %}
                                        <li class="disabled">
                                            <a onclick="return false;" href="#" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}

                                    <li><a onclick="return false;" href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ currentPage }}" class="active">{{ currentPage }}</a></li>

                                    {% if currentPage < lastPage %}
                                        {% for i in range(currentPage+1, currentPage + 1 + nearbyPagesLimit) -%}
                                            {% if ( i <= lastPage ) %}
                                                <li><a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ i }}">{{ i }}</a></li>
                                            {% endif %}
                                        {%- endfor %}

                                        {% if  (lastPage - extremePagesLimit) > (currentPage + nearbyPagesLimit) %}
                                            <li><span>&hellip;</span></li>
                                        {% endif %}

                                        {% for i in range(lastPage - extremePagesLimit+1, lastPage+1) -%}
                                            {% if ( i > currentPage + nearbyPagesLimit ) %}
                                                <li><a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ i }}">{{ i }}</a></li>
                                            {% endif %}
                                        {%- endfor %}

                                        <li>
                                            <a href="{{ routePath_withoutPage }}{{ paging_queryParamJoinChar }}page={{ currentPage + 1 }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% elif showAlwaysFirstAndLast %}
                                        <li class="disabled">
                                            <a onclick="return false;" href="#" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                    </div>
                </div><!-- .row -->
            </div>

        </div><!-- .array-content -->

    </section>
{% endblock %}

{% block footer %}
    {% include "../partials/footer.html" %}
{% endblock %}}

{% block inlineScript %}
    {{ super() }}

    <script type="text/javascript" src="/javascripts/lib/scrollmagic/ScrollMagic.js"></script>
    <script type="text/javascript" src="/javascripts/module/gallery.js"></script>
{% endblock %}