{% extends "../../layout/ajax.html" %}

{% block content %}
{% set finalizedFieldName = field | finalizeColumnName %}
<form class="format-field">
    <div class="alert alert-danger hidden" role="alert">{{ error }}</div>

    <input type="hidden" id="field" value="{{ finalizedFieldName }}">

    <div class="form-group">
        <div class="col-xs-4">
            <label for="name" class="form-control">Name</label>
        </div>
        <div class="col-xs-8">
            <input id="name" class="form-control" name="name" value="{{ field }}" {{ 'readonly' if not customMode or finalizedFieldName != '' }} required/>
        </div>
    </div>

    <input type="hidden" id="custom_mode" value="{{ customMode }}"/>

    {% if not customMode %}

    <div class="form-group">
        <div class="col-xs-4">
            <label for="firstRecord" class="form-control">First Record</label>
        </div>
        <div class="col-xs-8">
            <input id="firstRecord" class="form-control" value="{{ firstRecord }}" readonly/>
        </div>
    </div>

    <div class="form-group">
        <div class="col-xs-4">
            <label for="dataType" class="form-control">Data Type</label>
        </div>
        <div class="col-xs-8">
            <select id="dataType" class="form-control" name="dataType">
                {% for coercion in available_forFieldDataType_coercions %}
                <option value="{{ coercion.operation }}" {{ 'selected' if coercion | fieldDataType_coercion_toString == doc.raw_rowObjects_coercionScheme[finalizedFieldName] | fieldDataType_coercion_toString }}>
                {{ coercion | fieldDataType_coercion_toString }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <div class="col-xs-4">
            <label for="dataFormat" class="form-control">Format</label>
        </div>
        <div class="col-xs-8">
            <input type="text" id="dataFormat" name="dataFormat" class="form-control"
                   value="{{ doc.raw_rowObjects_coercionScheme[finalizedFieldName].format | safe }}"
                   title="Specify in which format the field is listed on the source file."/>
        </div>
    </div>

    <div class="form-group">
        <div class="col-xs-4">
            <label for="dataOutputFormat" class="form-control">Output Format</label>
        </div>
        <div class="col-xs-8">
            <input type="text" id="dataOutputFormat" name="dataOutputFormat" class="form-control"
                   value="{{ doc.raw_rowObjects_coercionScheme[finalizedFieldName].outputFormat | safe }}"
                   title="Specify in which output format the field will be used to display, if you want to customize the field format"/>
        </div>
    </div>

    {% else %}
    <div class="form-group">
        <div class="col-xs-4">
            <label for="dataType" class="form-control">Data Type</label>
        </div>
        <div class="col-xs-8">
            <input type="text" class="form-control" name="dataType" value="Array" readonly>
        </div>
    </div>

    <div class="form-group">
        <div class="col-xs-4">
            <label for="fieldsToMergeIntoArray" class="form-control">Fields To Merge</label>
        </div>
        <div class="col-xs-8">
            <select multiple name="fieldsToMergeIntoArray" id="fieldsToMergeIntoArray" class="chosen-select" required>
                <option value=""></option>
                {% for colName in colNames %}
                <option value="{{ colName | finalizeColumnName }}" {{ 'selected' if customField.fieldsToMergeIntoArray | doesArrayContain(colName | finalizeColumnName) }}>{{ colName }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}

    <div class="form-group">
        <div class="col-xs-4">
            <label for="exclude" class="form-control">Exclude</label>
        </div>
        <div class="col-xs-8">
            <input type="checkbox" id="exclude" name="exclude" value="true" {{ 'checked=checked' if
            doc.fe_excludeFields | doesArrayContain(finalizedFieldName) }} />
        </div>
    </div>

    {% if not customMode %}

    <div class="form-group">
        <div class="col-xs-4">
            <label for="titleOverride" class="form-control">Title Override</label>
        </div>
        <div class="col-xs-8">
            <input type="text" id="titleOverride" name="titleOverride" class="form-control" value="{{ doc.fe_displayTitleOverrides[finalizedFieldName] | safe }}"/>
        </div>
    </div>

    {% endif %}

    <div class="form-group">
        <div class="col-xs-4">
            <label for="displayOrder" class="form-control">Display Order</label>
        </div>
        <div class="col-xs-8">
            <input type="number" id="displayOrder" name="displayOrder" class="form-control" value="{{ doc.fe_fieldDisplayOrder[finalizedFieldName] | safe }}"/>
        </div>
    </div>

    {% if not customMode %}

    <div class="form-group">
        <div class="col-xs-4">
            <label for="designatedField" class="form-control">Designated Field</label>
        </div>
        <div class="col-xs-8">
            <select id="designatedField" name="designatedField" class="form-control">
                <option value="">Not used</option>
                <option value="objectTitle" {{ 'selected' if doc.fe_designatedFields.objectTitle == finalizedFieldName }}>Object Title</option>
                <option value="originalImageURL" {{ 'selected' if doc.fe_designatedFields.originalImageURL == finalizedFieldName }}>Original Image URL</option>
                <option value="medThumbImageURL" {{ 'selected' if doc.fe_designatedFields.medThumbImageURL == finalizedFieldName }}>Medium Thumb Image URL</option>
            </select>
        </div>
    </div>

    {% endif %}

    <div class="more-settings">
        <h4>Filter</h4>

        <div class="form-group">
            <div class="col-xs-8">
                <label for="filter_notAvailable" class="form-control">Not Available</label>
            </div>
            <div class="col-xs-4">
                <input type="checkbox" id="filter_notAvailable" name="filter_notAvailable" value="true"
                       {{ 'checked=checked' if doc.fe_filters.fieldsNotAvailable | doesArrayContain(finalizedFieldName) }}/>
            </div>
        </div>

        {% if not customMode %}

        <div class="form-group">
            <div class="col-xs-8">
                <label for="filter_commaSeparatedAsIndividual" class="form-control">Comma Separated As Individual</label>
            </div>
            <div class="col-xs-4">
                <input type="checkbox" id="filter_commaSeparatedAsIndividual" name="filter_commaSeparatedAsIndividual"
                       value="true" {{ 'checked=checked' if doc.fe_filters.fieldsCommaSeparatedAsIndividual | doesArrayContain(finalizedFieldName) }}/>
            </div>
        </div>

        <div class="form-group">
            <div class="col-xs-8">
                <label for="filter_multiSelectable" class="form-control">Allow Multiple Selection</label>
            </div>
            <div class="col-xs-4">
                <input type="checkbox" id="filter_multiSelectable" name="filter_multiSelectable" value="true"
                       {{ 'checked=checked' if doc.fe_filters.fieldsMultiSelectable | doesArrayContain(finalizedFieldName) }}/>
            </div>
        </div>

        {% endif %}

        <div class="form-group">
            <div class="col-xs-8">
                <label for="filter_sortableByInteger" class="form-control">Sortable By Integer</label>
            </div>
            <div class="col-xs-4">
                <input type="checkbox" id="filter_sortableByInteger" name="filter_sortableByInteger" value="true"
                       {{ 'checked=checked' if doc.fe_filters.fieldsSortableByInteger | doesArrayContain(finalizedFieldName) }}/>
            </div>
        </div>

        {% if not customMode %}

        <div class="form-group row">
            <div class="col-xs-8">
                <label class="form-control">One To One Override Values By Title</label>
            </div>
            <div class="col-xs-4">
                <a id="add_oneToOneOverrideWithValuesByTitle" class="add">
                    <span class="glyphicon glyphicon-plus"></span> Add more
                </a>
            </div>
        </div>
        <div id="extra_oneToOneOverrideWithValuesByTitle">
            {% set titleOverride = doc.fe_displayTitleOverrides[finalizedFieldName] if doc.fe_displayTitleOverrides[finalizedFieldName] else finalizedFieldName %}
            {% for value, title in doc.fe_filters.oneToOneOverrideWithValuesByTitleByFieldName[titleOverride] %}
            <div class="form-group row">
                <div class="col-xs-5">
                    <label>Title</label><input type="text" value="{{ title }}" name="oneToOneOverrideWithTitle[]" class="form-control">
                </div>
                <div class="col-xs-6">
                    <label>Override</label><input type="text" value="{{ value }}" name="oneToOneOverrideWithValue[]" class="form-control">
                </div>
                <div class="col-xs-1">
                    <a class="removeRow"><span class="glyphicon glyphicon-remove"></span></a>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="form-group">
            <div class="col-xs-8">
                <label class="form-control">Values to Exclude by Original Key</label>
            </div>
            <div class="col-xs-4">
                <a id="add_valueToExcludeByOriginalKey" class="add">
                    <span class="glyphicon glyphicon-plus"></span> Add more
                </a>
            </div>
        </div>
        <div id="extra_valuesToExcludeByOriginalKey">
            {% for key, values in doc.fe_filters.valuesToExcludeByOriginalKey %}
            {% if key == '_all' or key == finalizedFieldName %}
            {% for value in values %}
            <div class="form-group row">
                <div class="col-xs-6">
                    <input type="text" class="form-control" name="valuesToExcludeByOriginalKey[]" value="{{ value if value or value != '' else 'null' }}">
                </div>
                <div class="col-xs-5">
                    <input type="checkbox" name="valuesToExcludeByOriginalKey_applyTo[]" {{ 'checked=checked' if key == '_all' }} value="true"/> Apply to All
                </div>
                <div class="col-xs-1">
                    <a class="removeRow"><span class="glyphicon glyphicon-remove"></span></a>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </div>

        <div class="form-group">
            <div class="col-xs-8">
                <label class="form-control">Keywords</label>
            </div>
            <div class="col-xs-4">
                <a id="add_filterKeyword" class="add">
                    <span class="glyphicon glyphicon-plus"></span> Add more
                </a>
            </div>
        </div>
        <div id="extra_keywords">
            {% for filter in doc.fe_filters.keywords %}
            {% if filter.title == titleOverride %}
            {% for choice in filter.choices %}
            {% if doc.fe_filters.default and doc.fe_filters.default[title] | doesArrayContain(choice) %}
            {% set is_default_filter = true %}
            {% endif %}
            <div class="form-group row">
                <div class="col-xs-8">
                    <input type="text" class="form-control" name="filter_keywords[]" value="{{ choice }}">
                </div>
                <div class="col-xs-3">
                    <input type="checkbox" name="default_filter_keywords[]" values="true" {{ 'checked=checked' if is_default_filter }}> Use default
                </div>
                <div class="col-xs-1">
                    <a class="removeRow"><span class="glyphicon glyphicon-remove"></span></a>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </div>

        {% endif %}

        {% if not customMode %}

        <h4>Nested</h4>

        <div class="form-group">
            <div class="col-xs-4">
                <label for="chk_nested" class="form-control">Is Nested?</label>
            </div>
            <div class="col-xs-8">
                <input type="checkbox" id="chk_nested" class="chk_nested" name="nested_field" {{ 'checked="checked"' if doc.fe_nestedObject and doc.fe_nestedObject.fields | doesArrayContain(finalizedFieldName) and not (doc.fe_nestedObject.criteria and doc.fe_nestedObject.criteria.fieldName == finalizedFieldName) }} value="true">
            </div>
        </div>

        <div class="form-group">
            <div class="col-xs-4">
                <label for="nested_criteria" class="form-control">Is Criteria?</label>
            </div>
            <div class="col-xs-8">
                <input type="checkbox" id="nested_criteria" name="nested_criteria" {{ 'checked="checked"' if doc.fe_nestedObject and doc.fe_nestedObject.criteria and doc.fe_nestedObject.criteria.fieldName == finalizedFieldName }} value="true"/>
            </div>
        </div>

        <div class="form-group">
            <div class="col-xs-4">
                <label for="nested_prefix" class="form-control">Prefix</label>
            </div>
            <div class="col-xs-8">
                <input type="text" id="nested_prefix" class="form-control" name="nested_prefix" value="{{ doc.fe_nestedObject.prefix if doc.fe_nestedObject }}"/>
            </div>
        </div>

        <div class="form-group">
            <div class="col-xs-4">
                <label for="nested_fieldOverride" class="form-control">Field Name Override</label>
            </div>
            <div class="col-xs-8">
                <input type="text" id="nested_fieldOverride" class="form-control" name="nested_fieldOverride" value="{{ doc.fe_nestedObject.fieldOverrides[finalizedFieldName] if doc.fe_nestedObject and doc.fe_nestedObject.fieldOverrides and doc.fe_nestedObject.fieldOverrides[finalizedFieldName] }}"/>
            </div>
        </div>

        <div class="form-group">
            <div class="col-xs-4">
                <label class="form-control">Value Overrides</label>
            </div>
            <div class="col-xs-8">
                <a id="add_nested_valueOverride" class="add">
                    <span class="glyphicon glyphicon-plus"></span> Add more
                </a>
            </div>
        </div>
        <div id="extra_nested_valueOverrides">
            {% if doc.fe_nestedObject and doc.fe_nestedObject.valueOverrides and doc.fe_nestedObject.valueOverrides[finalizedFieldName] %}
                {% for key,value in doc.fe_nestedObject.valueOverrides[finalizedFieldName] %}
                    <div class="form-group row">
                        <div class="col-xs-offset-1 col-xs-4">
                            <input type="text" class="form-control" name="nested_valueOverride_keys[]" value="{{ key }}"/>
                        </div>
                        <div class="col-xs-1">=></div>
                        <div class="col-xs-4">
                            <input type="text" class="form-control" name="nested_valueOverride_values[]" value="{{ value }}"/>
                        </div>
                        <div class="col-xs-2">
                            <a class="removeRow"><span class="glyphicon glyphicon-remove"></span></a>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <h4>Relationships</h4>

        <div class="form-group">
            <div class="col-xs-4">

            </div>
            <div class="col-xs-8">

            </div>
        </div>

        {% endif %}

    </div>

    <button type="button" class="form-control show-more-settings">Show More Settings</button>

    <div class="form-group">
        <div class="col-xs-4">
            {% if customMode and field %}
            <button id="format-field-remove" type="button" class="pull-right form-control">Remove</button>
            {% endif %}
        </div>
        <div class="col-xs-4">
            <button id="format-field-reset" type="button" class="pull-right form-control">Reset</button>
        </div>
        <div class="col-xs-4">
            <button id="format-field-done" type="button" class="pull-right form-control">Done</button>
        </div>
    </div>
</form>
{% endblock %}